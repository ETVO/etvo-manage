<?php
header('Access-Control-Allow-Origin: https://etvo-web.com');

include dirname(__FILE__) . '/util.php';
include dirname(__FILE__) . '/form_util.php';

$model = get_model('contact');

$is_ajax = isset($_GET['ajax']) ? $_GET['ajax'] : false;
$actual_link = isset($_POST['actual_link']) ? $_POST['actual_link'] : false;
$form_anchor = isset($_POST['form-anchor']) ? $_POST['form-anchor'] : '#contact';

$auth = array(
    'host' => 'etvo-web.com',
    'username' => 'admin@etvo-web.com',
    'password' => 'secret'
);

$errors = array();

// check for honeypot
$honeypot = $model['honeypot'];
if (isset($_POST[$honeypot]) && $_POST[$honeypot] != '') {

    $response = $model['response']['honeypot'];
    http_response_code(400);

    if ($is_ajax) {
        echo $response;
    } else {
        $redirect = "?form_status=success&form_message=$response&$form_anchor";
        header("Location: " . $actual_link . $redirect);
    }
    exit; //just in case
}

// no honeypot, proceed to form fields validation
foreach ($model['fields'] as $key => $field) {
    if ($field['type'] == 'select') {
        $value = (isset($_POST[$key])) ? $_POST[$key] : '';
    } else {
        $value = $_POST[$key];
    }

    if (!isset($field['required'])) $field['required'] = false;

    if (!filter_field($value, $field['type'], $field['required'])) {
        $label = $field['label'] ?? $field['placeholder'] ?? '?';
        if ($field['type'] == 'email') {
            $errors[$key] = 'Please insert a valid ' . $label;
        } else {
            $errors[$key] = $label . ' is required';
        }
    }
}


if (empty($errors)) {

    $to = $model['to']; // Replace with your email address
    $subject = $model['subject'];
    $from = $_POST['email'];

    $style = <<<EOD
    * {font-family: "Inter", "Trebuchet MS", "Roboto", sans-serif; } 
    div { padding: 24px; background-color: #fbf6f6; color: #2E282A; } 
    div * { color: inherit; }
    svg { width: 240px; height: auto; }
    EOD;

    $body = '';

    $body .= "<style>$style</style>";
    $body .= '<div>';
    $body .= '<h1>New Form Submission</h1>';
    $body .= "<br />";
    $body .= '<h2>Information:</h2>';
    $body .= "<br />";
    
    foreach ($model['fields'] as $key => $field) {
        $value = (isset($_POST[$key]) && $_POST[$key] != '') ? $_POST[$key] : '-';
        $label = (isset($field['label'])) ? $field['label'] : $field['placeholder'] ?? '';
        
        $body .= "<br /><b>$label</b>&nbsp;&nbsp;&nbsp;$value<br />";
        $body .= "<hr />";
    }
    $body .= "<br /><small><p>Congratulations and good luck with this new lead.
    <br />Remember to keep track of the pipeline, answer in a timely manner, and be professional and polite.
    <br />Help this person with what they need in every way you can.</p>";
    $body .= "<p>WHO&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;WHAT&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;WHEN&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;WHERE&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;WHY&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;HOW</p>";
    $body .= "</small>";
    $body .= '<br />';
    $body .= '<svg width="183" height="71" viewBox="0 0 183 71" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path d="M33.8294 17C33.8294 13.6377 32.8519 10.3509 31.0206 7.55531C29.1892 4.75968 26.5863 2.58074 23.5408 1.29405C20.4954 0.00736568 17.1443 -0.329291 13.9113 0.326658C10.6782 0.982606 7.70853 2.6017 5.37765 4.97919C3.04678 7.35668 1.45943 10.3858 0.816346 13.6835C0.17326 16.9811 0.503315 20.3993 1.76478 23.5056C3.02624 26.612 5.16244 29.267 7.90326 31.135C10.6441 33.003 13.8664 34 17.1628 34V25.5C15.5146 25.5 13.9034 25.0015 12.533 24.0675C11.1626 23.1335 10.0945 21.806 9.46377 20.2528C8.83304 18.6996 8.66801 16.9906 8.98955 15.3417C9.3111 13.6929 10.1048 12.1783 11.2702 10.9896C12.4356 9.80085 13.9205 8.9913 15.537 8.66333C17.1535 8.33535 18.8291 8.50368 20.3518 9.14703C21.8745 9.79037 23.176 10.8798 24.0917 12.2777C25.0074 13.6755 25.4961 15.3189 25.4961 17H33.8294Z" fill="#2E282A"/>
    <path d="M17.1628 17C17.1628 20.3623 18.1402 23.6491 19.9716 26.4447C21.803 29.2403 24.4059 31.4193 27.4514 32.7059C30.4968 33.9926 33.8479 34.3293 37.0809 33.6733C40.3139 33.0174 43.2837 31.3983 45.6145 29.0208C47.9454 26.6433 49.5328 23.6142 50.1758 20.3165C50.8189 17.0189 50.4889 13.6007 49.2274 10.4944C47.966 7.38804 45.8297 4.73301 43.0889 2.86502C40.3481 0.99704 37.1258 8.80548e-06 33.8294 9.14842e-06L33.8294 8.5C35.4776 8.5 37.0888 8.99852 38.4592 9.93251C39.8296 10.8665 40.8977 12.194 41.5284 13.7472C42.1591 15.3004 42.3242 17.0094 42.0026 18.6583C41.6811 20.3071 40.8874 21.8217 39.722 23.0104C38.5565 24.1992 37.0717 25.0087 35.4552 25.3367C33.8387 25.6646 32.1631 25.4963 30.6404 24.853C29.1177 24.2096 27.8162 23.1202 26.9005 21.7223C25.9848 20.3245 25.4961 18.6811 25.4961 17L17.1628 17Z" fill="#2E282A"/>
    <path d="M1.51705 47.5455H6.06818L10.875 59.2727H11.0795L15.8864 47.5455H20.4375V65H16.858V53.6392H16.7131L12.196 64.9148H9.75852L5.24148 53.5966H5.09659V65H1.51705V47.5455ZM27.1428 65.2472C26.3075 65.2472 25.5632 65.1023 24.9098 64.8125C24.2564 64.517 23.7393 64.0824 23.3587 63.5085C22.9837 62.929 22.7962 62.2074 22.7962 61.3438C22.7962 60.6165 22.9297 60.0057 23.1967 59.5114C23.4638 59.017 23.8274 58.6193 24.2876 58.3182C24.7479 58.017 25.2706 57.7898 25.8558 57.6364C26.4467 57.483 27.0661 57.375 27.7138 57.3125C28.4751 57.233 29.0888 57.1591 29.5547 57.0909C30.0206 57.017 30.3587 56.9091 30.5689 56.767C30.7791 56.625 30.8842 56.4148 30.8842 56.1364V56.0852C30.8842 55.5455 30.7138 55.1278 30.3729 54.8324C30.0376 54.5369 29.5604 54.3892 28.9411 54.3892C28.2876 54.3892 27.7678 54.5341 27.3814 54.8239C26.995 55.108 26.7393 55.4659 26.6143 55.8977L23.2564 55.625C23.4268 54.8295 23.7621 54.142 24.2621 53.5625C24.7621 52.9773 25.407 52.5284 26.1967 52.2159C26.9922 51.8977 27.9126 51.7386 28.9581 51.7386C29.6854 51.7386 30.3814 51.8239 31.0462 51.9943C31.7166 52.1648 32.3104 52.429 32.8274 52.7869C33.3501 53.1449 33.7621 53.6051 34.0632 54.1676C34.3643 54.7244 34.5149 55.392 34.5149 56.1705V65H31.0717V63.1847H30.9695C30.7592 63.5938 30.478 63.9545 30.1257 64.267C29.7734 64.5739 29.3501 64.8153 28.8558 64.9915C28.3615 65.1619 27.7905 65.2472 27.1428 65.2472ZM28.1825 62.7415C28.7166 62.7415 29.1882 62.6364 29.5973 62.4261C30.0064 62.2102 30.3274 61.9205 30.5604 61.5568C30.7933 61.1932 30.9098 60.7812 30.9098 60.321V58.9318C30.7962 59.0057 30.6399 59.0739 30.4411 59.1364C30.2479 59.1932 30.0291 59.2472 29.7848 59.2983C29.5405 59.3437 29.2962 59.3864 29.0518 59.4261C28.8075 59.4602 28.5859 59.4915 28.3871 59.5199C27.9609 59.5824 27.5888 59.6818 27.2706 59.8182C26.9524 59.9545 26.7053 60.1392 26.5291 60.3722C26.353 60.5994 26.2649 60.8835 26.2649 61.2244C26.2649 61.7188 26.4439 62.0966 26.8018 62.358C27.1655 62.6136 27.6257 62.7415 28.1825 62.7415ZM40.6214 61.233L40.63 56.8778H41.1584L45.3516 51.9091H49.5192L43.8857 58.4886H43.0249L40.6214 61.233ZM37.3317 65V47.5455H40.9624V65H37.3317ZM45.5135 65L41.6612 59.2983L44.0817 56.733L49.7663 65H45.5135ZM56.7273 65.2557C55.3807 65.2557 54.2216 64.983 53.25 64.4375C52.2841 63.8864 51.5398 63.108 51.017 62.1023C50.4943 61.0909 50.233 59.8949 50.233 58.5142C50.233 57.1676 50.4943 55.9858 51.017 54.9688C51.5398 53.9517 52.2756 53.1591 53.2244 52.5909C54.179 52.0227 55.2983 51.7386 56.5824 51.7386C57.446 51.7386 58.25 51.8778 58.9943 52.1562C59.7443 52.429 60.3977 52.8409 60.9545 53.392C61.517 53.9432 61.9545 54.6364 62.267 55.4716C62.5795 56.3011 62.7358 57.2727 62.7358 58.3864V59.3835H51.6818V57.1335H59.3182C59.3182 56.6108 59.2045 56.1477 58.9773 55.7443C58.75 55.3409 58.4347 55.0256 58.0312 54.7983C57.6335 54.5653 57.1705 54.4489 56.642 54.4489C56.0909 54.4489 55.6023 54.5767 55.1761 54.8324C54.7557 55.0824 54.4261 55.4205 54.1875 55.8466C53.9489 56.267 53.8267 56.7358 53.821 57.2528V59.392C53.821 60.0398 53.9403 60.5994 54.179 61.071C54.4233 61.5426 54.767 61.9062 55.2102 62.1619C55.6534 62.4176 56.179 62.5455 56.7869 62.5455C57.1903 62.5455 57.5597 62.4886 57.8949 62.375C58.2301 62.2614 58.517 62.0909 58.7557 61.8636C58.9943 61.6364 59.1761 61.358 59.3011 61.0284L62.6591 61.25C62.4886 62.0568 62.1392 62.7614 61.6108 63.3636C61.0881 63.9602 60.4119 64.4261 59.5824 64.7614C58.7585 65.0909 57.8068 65.2557 56.7273 65.2557ZM74.4183 47.5455V65H70.728V47.5455H74.4183ZM84.3494 51.9091V54.6364H76.4659V51.9091H84.3494ZM78.2557 48.7727H81.8864V60.9773C81.8864 61.3125 81.9375 61.5739 82.0398 61.7614C82.142 61.9432 82.2841 62.071 82.4659 62.1449C82.6534 62.2187 82.8693 62.2557 83.1136 62.2557C83.2841 62.2557 83.4545 62.2415 83.625 62.2131C83.7955 62.179 83.9261 62.1534 84.017 62.1364L84.5881 64.8381C84.4063 64.8949 84.1506 64.9602 83.821 65.0341C83.4915 65.1136 83.0909 65.1619 82.6193 65.179C81.7443 65.2131 80.9773 65.0966 80.3182 64.8295C79.6648 64.5625 79.1563 64.1477 78.7926 63.5852C78.429 63.0227 78.25 62.3125 78.2557 61.4545V48.7727ZM92.3374 65V47.5455H96.0277V54.7472H103.519V47.5455H107.201V65H103.519V57.7898H96.0277V65H92.3374ZM113.908 65.2472C113.073 65.2472 112.329 65.1023 111.675 64.8125C111.022 64.517 110.505 64.0824 110.124 63.5085C109.749 62.929 109.562 62.2074 109.562 61.3438C109.562 60.6165 109.695 60.0057 109.962 59.5114C110.229 59.017 110.593 58.6193 111.053 58.3182C111.513 58.017 112.036 57.7898 112.621 57.6364C113.212 57.483 113.832 57.375 114.479 57.3125C115.241 57.233 115.854 57.1591 116.32 57.0909C116.786 57.017 117.124 56.9091 117.335 56.767C117.545 56.625 117.65 56.4148 117.65 56.1364V56.0852C117.65 55.5455 117.479 55.1278 117.138 54.8324C116.803 54.5369 116.326 54.3892 115.707 54.3892C115.053 54.3892 114.533 54.5341 114.147 54.8239C113.761 55.108 113.505 55.4659 113.38 55.8977L110.022 55.625C110.192 54.8295 110.528 54.142 111.028 53.5625C111.528 52.9773 112.173 52.5284 112.962 52.2159C113.758 51.8977 114.678 51.7386 115.724 51.7386C116.451 51.7386 117.147 51.8239 117.812 51.9943C118.482 52.1648 119.076 52.429 119.593 52.7869C120.116 53.1449 120.528 53.6051 120.829 54.1676C121.13 54.7244 121.281 55.392 121.281 56.1705V65H117.837V63.1847H117.735C117.525 63.5938 117.244 63.9545 116.891 64.267C116.539 64.5739 116.116 64.8153 115.621 64.9915C115.127 65.1619 114.556 65.2472 113.908 65.2472ZM114.948 62.7415C115.482 62.7415 115.954 62.6364 116.363 62.4261C116.772 62.2102 117.093 61.9205 117.326 61.5568C117.559 61.1932 117.675 60.7812 117.675 60.321V58.9318C117.562 59.0057 117.406 59.0739 117.207 59.1364C117.013 59.1932 116.795 59.2472 116.55 59.2983C116.306 59.3437 116.062 59.3864 115.817 59.4261C115.573 59.4602 115.352 59.4915 115.153 59.5199C114.727 59.5824 114.354 59.6818 114.036 59.8182C113.718 59.9545 113.471 60.1392 113.295 60.3722C113.119 60.5994 113.031 60.8835 113.031 61.2244C113.031 61.7188 113.21 62.0966 113.567 62.358C113.931 62.6136 114.391 62.7415 114.948 62.7415ZM124.097 69.9091V51.9091H127.677V54.108H127.839C127.998 53.7557 128.228 53.3977 128.529 53.0341C128.836 52.6648 129.234 52.358 129.722 52.1136C130.217 51.8636 130.83 51.7386 131.563 51.7386C132.518 51.7386 133.398 51.9886 134.205 52.4886C135.012 52.983 135.657 53.7301 136.14 54.7301C136.623 55.7244 136.864 56.9716 136.864 58.4716C136.864 59.9318 136.629 61.1648 136.157 62.1705C135.691 63.1705 135.055 63.929 134.248 64.446C133.447 64.9574 132.549 65.2131 131.555 65.2131C130.85 65.2131 130.251 65.0966 129.756 64.8636C129.268 64.6307 128.867 64.3381 128.555 63.9858C128.242 63.6278 128.004 63.267 127.839 62.9034H127.728V69.9091H124.097ZM127.651 58.4545C127.651 59.233 127.759 59.9119 127.975 60.4915C128.191 61.071 128.504 61.5227 128.913 61.8466C129.322 62.1648 129.819 62.3239 130.404 62.3239C130.995 62.3239 131.495 62.1619 131.904 61.8381C132.313 61.5085 132.623 61.054 132.833 60.4744C133.049 59.8892 133.157 59.2159 133.157 58.4545C133.157 57.6989 133.052 57.0341 132.842 56.4602C132.631 55.8864 132.322 55.4375 131.913 55.1136C131.504 54.7898 131.001 54.6278 130.404 54.6278C129.813 54.6278 129.313 54.7841 128.904 55.0966C128.501 55.4091 128.191 55.8523 127.975 56.4261C127.759 57 127.651 57.6761 127.651 58.4545ZM139.285 69.9091V51.9091H142.864V54.108H143.026C143.185 53.7557 143.415 53.3977 143.717 53.0341C144.023 52.6648 144.421 52.358 144.91 52.1136C145.404 51.8636 146.018 51.7386 146.751 51.7386C147.705 51.7386 148.586 51.9886 149.393 52.4886C150.2 52.983 150.844 53.7301 151.327 54.7301C151.81 55.7244 152.052 56.9716 152.052 58.4716C152.052 59.9318 151.816 61.1648 151.344 62.1705C150.879 63.1705 150.242 63.929 149.435 64.446C148.634 64.9574 147.737 65.2131 146.742 65.2131C146.038 65.2131 145.438 65.0966 144.944 64.8636C144.455 64.6307 144.055 64.3381 143.742 63.9858C143.43 63.6278 143.191 63.267 143.026 62.9034H142.915V69.9091H139.285ZM142.839 58.4545C142.839 59.233 142.947 59.9119 143.163 60.4915C143.379 61.071 143.691 61.5227 144.1 61.8466C144.509 62.1648 145.006 62.3239 145.592 62.3239C146.183 62.3239 146.683 62.1619 147.092 61.8381C147.501 61.5085 147.81 61.054 148.021 60.4744C148.237 59.8892 148.344 59.2159 148.344 58.4545C148.344 57.6989 148.239 57.0341 148.029 56.4602C147.819 55.8864 147.509 55.4375 147.1 55.1136C146.691 54.7898 146.188 54.6278 145.592 54.6278C145.001 54.6278 144.501 54.7841 144.092 55.0966C143.688 55.4091 143.379 55.8523 143.163 56.4261C142.947 57 142.839 57.6761 142.839 58.4545ZM160.438 65.2557C159.092 65.2557 157.933 64.983 156.961 64.4375C155.995 63.8864 155.251 63.108 154.728 62.1023C154.205 61.0909 153.944 59.8949 153.944 58.5142C153.944 57.1676 154.205 55.9858 154.728 54.9688C155.251 53.9517 155.987 53.1591 156.935 52.5909C157.89 52.0227 159.009 51.7386 160.293 51.7386C161.157 51.7386 161.961 51.8778 162.705 52.1562C163.455 52.429 164.109 52.8409 164.665 53.392C165.228 53.9432 165.665 54.6364 165.978 55.4716C166.29 56.3011 166.447 57.2727 166.447 58.3864V59.3835H155.393V57.1335H163.029C163.029 56.6108 162.915 56.1477 162.688 55.7443C162.461 55.3409 162.146 55.0256 161.742 54.7983C161.344 54.5653 160.881 54.4489 160.353 54.4489C159.802 54.4489 159.313 54.5767 158.887 54.8324C158.467 55.0824 158.137 55.4205 157.898 55.8466C157.66 56.267 157.538 56.7358 157.532 57.2528V59.392C157.532 60.0398 157.651 60.5994 157.89 61.071C158.134 61.5426 158.478 61.9062 158.921 62.1619C159.364 62.4176 159.89 62.5455 160.498 62.5455C160.901 62.5455 161.271 62.4886 161.606 62.375C161.941 62.2614 162.228 62.0909 162.467 61.8636C162.705 61.6364 162.887 61.358 163.012 61.0284L166.37 61.25C166.2 62.0568 165.85 62.7614 165.322 63.3636C164.799 63.9602 164.123 64.4261 163.293 64.7614C162.469 65.0909 161.518 65.2557 160.438 65.2557ZM172.447 57.4318V65H168.816V51.9091H172.276V54.2188H172.43C172.719 53.4574 173.205 52.8551 173.887 52.4119C174.569 51.9631 175.396 51.7386 176.367 51.7386C177.276 51.7386 178.069 51.9375 178.745 52.3352C179.421 52.733 179.947 53.3011 180.322 54.0398C180.697 54.7727 180.884 55.6477 180.884 56.6648V65H177.254V57.3125C177.259 56.5114 177.055 55.8864 176.64 55.4375C176.225 54.983 175.654 54.7557 174.927 54.7557C174.438 54.7557 174.006 54.8608 173.631 55.071C173.262 55.2812 172.972 55.5881 172.762 55.9915C172.558 56.3892 172.452 56.8693 172.447 57.4318Z" fill="#2E282A"/>
    </svg>';
    $body .= '</div>';


    try {
        send_mail($auth, $from, $to, $subject, $body);
        $response = $model['response']['success'];
    } catch (Exception $e) {
        $response = $model['response']['error'];
        http_response_code(400);
    }

    if ($is_ajax) {
        echo $response;
    } else {
        $redirect = "?form_status=success&form_message=$response&$form_anchor";
        header("Location: " . $actual_link . $redirect);
    }
} else {
    if ($is_ajax) {
        echo json_encode($errors); // Send errors as JSON response
        http_response_code(400); // Set response code to indicate error
    } else {
        $redirect = "?form_status=error&form_message=" . implode(',<br>', $errors) . "&$form_anchor";
        header("Location: " . $actual_link . $redirect);
    }
}
// endif;
